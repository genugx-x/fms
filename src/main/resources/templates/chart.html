<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <div th:replace="fragments/head.html :: fragment-head"></div>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
    <div id="vueApp">
        <el-container v-loading="loading"
                      element-loading-text="Loading..."
                      element-loading-spinner="el-icon-loading"
                      element-loading-background="rgba(0, 0, 0, 0.8)">
            <div th:replace="fragments/header.html :: fragment-header"></div>
            <el-container>
                    <div th:replace="fragments/aside.html :: fragment-aside"></div>
                <el-container>
                    <!--<div th:replace="layouts/layout.html :: fragment-main"></div>-->
                    <el-main>
                        <span id="latest_time"></span> <!--<span><button value="새로고침" onclick="window.location.reload()">새로고침</button></span>-->
                        <span><button onclick="window.open('/mof100/csv');void(0);">다운로드</button></span>
                        <span><button id="btnStop">중지</button></span>

                        <!-- 그래프 -->
                        <div id="curve_chart" style="width: 100%; height: 800px;"></div>

                    </el-main>
                </el-container>
            </el-container>
            <div th:replace="fragments/footer.html :: fragment-footer"></div>
        </el-container>
    </div>
</body>
    <script>

        Vue.component("qsol-page-title", {
            props: ["title"],
            template: "<div class='page-title'>{{ title }}</div>"
        })

        let vueApp = new Vue({
            el: '#vueApp',
            data: {
                chart : null,
                options : null,
                chartData : null,
                xhr : null,
                deviceId : Number(localStorage.getItem("deviceId")),
                createAt : '',
                loading: false,
                isDraw: false,
            },
            methods : {
                handleMenuItemClick: function (el) {
                    this.deviceId = el;
                    this.reloadGraph();
                },
                handleMenuClick: function() {
                    location.href = "/home";
                },
                handleOpen(key, keyPath) {
                    console.log(key, keyPath);
                },
                handleClose(key, keyPath) {
                    console.log(key, keyPath);
                },
                decodeDataForChart(data) {
                    let decodedData = data.map(d => {
                        return [d.createAt.format('kk:mm:ss')].concat(d.payload.map(p => {
                            return [p.max, p.min, p.avg]
                        })).flat();
                    });
                    return decodedData;
                },
                drawChart() {
                    var errorCount = 0;
                    let title = "";
                    switch (this.deviceId) {
                        case 1: title = "ecoaqua"; break;
                        case 2: title = "join01"; break;
                        case 3: title = "join02"; break;
                        case 4: title = "central01"; break;
                        case 5: title = "central02"; break;
                        case 6: title = "SG"; break;
                    }
                    this.options = {
                        title: title,
                        curveType: 'function',
                        legend: { position: 'bottom' },
                        chartArea:{left:100,top:50,width:'100%',height:'80%'}
                    };
                    this.chart = new google.visualization.LineChart(document.getElementById('curve_chart'));
                    (poll = () => {
                        //console.log("errorCount", errorCount);
                        if (errorCount > 100) return false;
                        let url = "/test/data/" + vueApp.deviceId
                        if (vueApp.createAt != '') url += "/" + vueApp.createAt;
                        //console.log("url", url);
                        this.xhr = $.get({
                            url: url,
                            success: (data) => {
                                //console.log("data", data);
                                if(data.length == 0) {
                                    vueApp.xhr.abort();
                                    throw new Error("조회된 데이터가 없습니다.");
                                }
                                errorCount = 0;
                                data.forEach(d => d.createAt = moment.utc(d.createAt).utcOffset(540))//.tz("Asia/Seoul"));
                                vueApp.createAt = data[10].createAt.format('YYYY-MM-DDTkk:mm:ss.SSS');
                                //console.log("vueApp.createAt", vueApp.createAt);
                                document.getElementById("latest_time").innerHTML = `${data[data.length - 1].createAt.format('MM/DD kk:mm:ss.SSS')} - ${data[0].createAt.format('MM/DD kk:mm:ss.SSS')}`
                                vueApp.chartData = google.visualization.arrayToDataTable(
                                    [['time', '진동최대', '진동최소', '진동평균', '전류최대', '전류최소', '전류평균'], ...vueApp.decodeDataForChart(data)]
                                );
                                vueApp.chart.draw(this.chartData, vueApp.options);
                                vueApp.loading = false;
                            }
                            , error: (data) => {
                                //console.error(data);
                                errorCount += 1
                                //console.log("errorCount:", errorCount)
                                if (errorCount > 100) vueApp.xhr.abort()
                                vueApp.loading = false;
                            }
                            , dataType: "json"
                            , complete: poll
                            , timeout: 600000
                        })
                    })();
                },
                reloadGraph() {
                    this.xhr.abort();
                    poll = null;
                    this.loading = true;
                    this.createAt = '';
                    google.charts.setOnLoadCallback(this.drawChart)
                },
            },
            mounted: function() {
                google.charts.load('current', {'packages':['corechart']});
                google.charts.setOnLoadCallback(this.drawChart)
            }
        })
    </script>
</html>